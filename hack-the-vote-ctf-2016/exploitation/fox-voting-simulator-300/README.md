# [Hack The Vote CTF 2016](https://pwn.voting): [FOX Voting Simulator 300](https://pwn.voting/challenges#FOX Voting Simulator)

**Category:** Exploitation
**Points:** 300
**Solves:** 26
**Description:**

> In primaries, it is important to get the most attention. With 12 candidates all sharing the stage, it can be hard to pull in voters. Luckily Mr Trump doesn't have much problem with that, but we have a strategy to secure the vote for good. We have found voters respond very well to name recognition, and which ever candidate is polling the highest. We see a snowball effect if we can tip a few online polls his way, then it will be easier for him to take the real ones, and then eventually the nomination.
>
> We were able to dump some of the source code from FOX's new online poll service. We couldn't get everything, but I'm sure that is no problem for you.
> [foxSim](https://s3.amazonaws.com/hackthevote/foxSim.7d62303c1c88beb1c9b59e49422d4eadce93e3daa42b7c6fb50248103ae69a2f.zip)
>
> nc fox.pwn.republican 9000
> 
> author's irc nick: itszn


## writeup

The downloadable challenge zip (hosted also
[here](./foxSim.7d62303c1c88beb1c9b59e49422d4eadce93e3daa42b7c6fb50248103ae69a2f.zip))
contains the C source of the FOX Voting Simulator service
listening at `fox.pwn.republican:9000`. However, observing the source it can be
found that a small part of it is missing: [`NWO_memberVote`](./foxSim/foxSim.c#L61) function (probably) defined in the missing [`nwo.h`](./foxSim/foxSim.c#L6) header.


### the program flow

Describing the service broadly:

1. it asks for your name (voter),
2. then asks for who you want to vote for (candidate),
3. and asks for the number of votes to give for the candidate.

This is a repeating procedure in an infinite loop called
[`voteLoop`](./foxSim/foxSim.c#L117-L160). The loop starts
after [setting up the candidates](./foxSim/foxSim.c#L164-L167),
and exits only if some exceptions happen.

The data for people (voters and candidates) are stored in
two kinds of structures:
[`Candidate`](./foxSim/fox.h#L4-L12) and
[`Person`](./foxSim/fox.h#L14-L19).

Note, that candidates set up during init are stored as `Candidate`,
you (the voters) are created as `Person`
by calling [`createPerson`](./foxSim/foxSim.c#L99-L107)
([if not exists(!)](./foxSim/foxSim.c#L135-L142)),
but both of them are stored in the same
[`hashMap`](./foxSim/foxSim.c#L31) hashed array using the
function [`hash`](./foxSim/foxSim.c#L11-L24).

Although the `Candidate` and `Person` struct definitions differ,
both of them have an `isCandidate` value and an `action`
function pointer.


### vulnerabilities

Observing the partial source code and experimenting with the
onine service some vulnerabilities can be found easily:

1. Any voter created as `Person`
[can vote for himself](./foxSim/foxSim.c#L63-L65) by giving arbitrary
number of votes. The system shows a
[warning ("Nice try...")](./foxSim/foxSim.c#L64), but
validates the number of votes given, and
[calls](./foxSim/foxSim.c#L83) the appropriate `action` function.
 * Impact: creating a `Person` and voting for himself calls
 its action function
 [`voteForWriteIn`](./foxSim/foxSim.c#L50-L56)
 which [dumps a string from memory](./foxSim/foxSim.c#L54)
 at address given by the number of votes. Note, that there
 is a minor limitation that the memory address given
 by the number of votes must be higher than the address of `main()`.
2. The hashing algorithm used for storing Persons and Candidates
is seriously vulnerable to collisions because the image space is
very small (the storage index is [`hashVal % 100`](./foxSim/foxSim.c#L36)).
 * Impact: The voter can lie his identity as a candidate, because
 the hashing is done by taking the
 [name as key](./foxSim/foxSim.c#L33-L42) and validating
 the identity against a candidate is done by
 [matching names](./foxSim/foxSim.c#L129-L134).
 So generating a collision by choosing a different name
 from the candidate but with the same hash value, the voter
 let the system believe that he is the candidate.
 Exploiting this vulnerability let an arbitrary voter
 call the (still unknown) [`NWO_memberVote`](./foxSim/foxSim.c#L60-L62)
 function.
3. Voting as a candidate does not require further checks,
e.g. it is allowed to vote for a `Person` (who is not a `Candidate`).
 * Impact: To learn the impact of this we should know the
 function `NWO_memberVote`.

Later we shall see that vulnerabilites #2 and #3 will lead to
full compromise.


### dumping the binary

By exploiting vulnerability #1 it is possible to dump the
binary (also the missing function from the source).

Note, that it is only possible to dump memory after beginning
of `main()` (trying to dump before `main()` gives a special
[`voteMessage`](./foxSim/foxSim.c#L51-L52)).
Moreover, trying to dump from memory section
where we do not have read permission will cause segfault
(fortunately the remote service respawns immediately).

So first we have to find the beginning of `main()`. This
can be done quickly by
[binary search](https://en.wikipedia.org/wiki/Binary_search_algorithm)
(using some guess for initial boundaries; addresses
around the standard image loading base `0x400000` seems to be ok).

After finding the start address of `main()` (`0x400820`), dumping the
binary (by string chunks terminated by `\x00`) until the end of
the memory section (`0x402000`) is straightforward.

The memory dumper script is available here, in the repo:
[01_dump_main.py](./01_dump_main.py).

The result of the dump is [foxSimulator_dump.bin](./foxSimulator_dump.bin).

Now it is time to reverse the dumped binary and look for the
missing `NWO_memberVote` function.
